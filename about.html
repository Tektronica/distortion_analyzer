<h1>STEPS FOR CALCULATING DISTORTION:</h1>
<h2>A. Time Series Data</h2>
<p>
Time series data is retrieved by the Fluke 8588A digitizer. The digitizer has a fixed sampling frequency of <b>5MHz</b>, which depending on the frequency of interest, could be considered excessive and drive up the number of samples required to appropriately window the time series data. Consequently, specifying an aperture length is a way of setting an equivalent sampling frequency lower than 5MHz. The aperture is the duration after each trigger where samples at a rate of 5 MHz are averaged together.
<br>
<br> Calculating the appropriate sample length, sampling frequency, and the aperture length requires some understanding of windowing that will be discussed in <b>Sections B and E</b> in greater detail.
<br>
<br>First the sampling frequency, Fs, is computed by selecting a frequency 100x larger than the fundamental (or frequency of interest). Note, an Fs of at least 10x larger than the frequency of interest tends to be a general rule of thumb. If the computed Fs is not equal to or larger than twice the specificed bandwidth for the given measurement, then twice the measurement bandwidth is chosen by default. However, this value of Fs may not be its final value since we still need to have an integer number of samples averaged per measurement by the digitizer to resolve this sampling frequency. Consequently, the sampling frequency is calculated twice: once more after calculating an integer number of samples to average by the digitizer.
<ol>
  <li><b>_Fs</b> = max( (2 * bw), (100 * F0) )</li>
  <li><b>samples_to_average</b> = int( 5MHz / _Fs ) = <b>25</b></li>
  <li><b>Fs</b> = 5MHz / samples_to_average = <b>200kHz</b></li>
</ol>
<br>
<br>Next, the sample length, <b>N</b>, is computed by finding the window length of the measurement. An error is expressed since the main lobe width is directly proportional to the number of cycles captured. The minimum value of <b>N</b> correlates to the lowest detectable frequency by the windowing function. For instance, blackman requires a minimum of 6 period cycles of the frequency of interest in order to express content of that lobe in the DFT. Sampling frequency does not play a role in the width of the lobe, only the resolution of the lobe.
<br>
<br>In this example, an error of 10% is specified. For a 1kHz fundamental, the main lobe width will maximally be 100Hz, the lowest detectable frequency, <b>ldf</b>.
<ol>
  <li><b>error</b> = 10%</li>
  <li><b>ldf</b> = f0 * error = <b>100Hz</b></li>
  <li><b>N</b> = int(6 * (fs / ldf)) = <b>12,000 samples</b></li>
</ol>
<br>
<br>Finally, the aperture is calculated. For this discussion, however, this won't be covered. Please review <b>Section F</b> to better understand how to compute the aperture provided the sampling frequency, Fs.
<ol>
  <li><b>aperture</b> = max(200e-9 * (samples_to_average - 1), 0) = <b>4.8us</b></li>
</ol>
<br>
<br>
</p>
<img src="images/static/00_sampled_data.jpg">

<h2>B. Windowing to reduce spectral leakage of non-integer periods</h2>
<p>
The FFT of discrete time series data (DFT) requires an integer number of cycles, otherwise, spectral leakage occurs in the form of additional artificial spectral content. Since an FFT assumes an infinite data series capable of looping back on itself, a non integer number of cycles (periods) creates a discontinuity between the first and last sample and so false harmonics are observed.
<br>
<br>A windowing function aims to mitigate the spectral error associated with data discontinuity by tapering the head and tail of the data series to attenuate the effect of the disconinuity. In this example, a blackman window was selected since it has greater side lobe attenuation at the cost of wider main lobe width. However, the main lobe width is equal to 6/N. That is, at least 6 cycles of the frequency of interest is required to resolve at least the frequency of interest and nothing lower. By increasing the sample length, additional cycles are captured, which help reduce the main lobe error width. Additional information on windowing can be found in section E further down on this page.
<br>
<br>Increasing the length of M for a given sampling frequency reduces the width of the main lobe. In other 
words, in situations where zero padding is not involved and M=N, the main lobe width is reduced by 
increasing the number of samples for a given sampling frequency.
<br>
<br>
</p>
<img src="images/static/01_window.jpg">

<p>
The time series data is then multiplied by the window (or convolved in the frequency domain). Tapering at the head and tail of the time series data is observed.
<br>
<br>
</p>
<img src="images/static/02_windowed_data.jpg">

<h2>C. The FFT</h2>
<p>
The FFT of the time series data with windowing applied is presented below. The fundamental at 1kHz and two odd order harmonics are resolved by the FFT. Note the maximum frequency of the FFT is half the sampling frequency of 200kHz as per Nyquist's sampling theorem. While the FFT resolves spectral content greater than 100kHz, the values are simply the complex conjugate of the postive spectral components. Consequently, this data is truncated from the plot; otherwise, the complex conjugate pairs are identical along the real axis besides mirrored across 100kHz.
<br>
<br>A total rms measurement is computed from the FFT data to later be used computing the THD+N.
<br>
<br>As per Parseval's theorem:
<br>
<br><b>total_rms</b> = np.sqrt(np.sum(np.abs(yf / N) ** 2))
<br>
<br>
</p>
<img src="images/static/03_fft_of_windowed_data.jpg">

<p>
To reject the fundamental frequency, the local minimas centered about the fundamental frequency are lcoated and values within these bounds are thrown out. This is more or less a crude attempt at notch rejection. A more appropriate method would be to calculate the main lobe width and reject within this bandwidth.
<br>
<br>A noise rms measurement is computed from the FFT data to later be used computing the THD+N.
<br>
<br>Again, as per Parseval's theorem:
<br><b>noise_rms</b> = np.sqrt(np.sum(np.abs(_yf / N) ** 2))
<br>
<br> <b>THDN</b> = noise_rms / total_rms
<br>
<br>
</p>
<img src="images/static/04_rejected_fundamental.jpg">

<h2>D. Characterizing an FFT</h2>
<img src="images/static/FFTResolution.jpg">

<h2>E. More on Windowing</h2>
<p>
The two characteristics that define a window in the time domain are the window length and shape. The two most relevant window characteristics in the frequency domain are the mainlobe width and the sidelobe height. The relationships between window length, mainlobe width, and sidelobe height are summarized in the following table for a number of commonly used window shapes. 
<br>
<br>M is the number of samples captured for a measurement of time series data. M refers to the length of the windowing filter applied to the. M≤N where N samples refers to the length of the FFT. When N is greater than M, zero padding is employed, which does not introduce new data to the FFT, but only increases the resolution of the FFT.
<br>
<br>The effective data length of captured period cycles are equal within this table. This means that a minimum of 6 cycles must be obtained to adequately use the blackman window to have the equivalent data length of a Hanning or Hamming window where only 4 cycles must be obtained.
<br>
<br>
</p>
<ul>
	<li>A longer window results in a narrower main lobe.</li>
	<li>A longer window improves the frequency resolution.</li>
</ul>
<p>
</p>
<table align="left" style="border-collapse: collapse;">
	<thead>
	<tr>
		<th>Window Shape</th>
		<th>Relative Peak Side Lobe Magnitude</th>
		<th>Approx. Main Lobe Width (Hz)</th>
	</tr>
	</thead>
	<tbody>
	<tr style="border-bottom: 1px solid black;">
		<td>Rectangular/boxcar</td>
		<td>-13 dB</td>
		<td>2/M</td>
	</tr>
	<tr>
		<td>Bartlett (triangle)</td>
		<td>-26 dB</td>
		<td>4/M</td>
	</tr>
	<tr>
		<td>Hanning (raised cosine)</td>
		<td>-31 dB</td>
		<td>4/M</td>
	</tr>
	<tr>
		<td>Hamming (raised cosine on pedestal)</td>
		<td>-42 dB</td>
		<td>4/M</td>
	</tr>
	<tr>
		<td>Blackman</td>
		<td>-58 dB</td>
		<td>6/M</td>
	</tr>
	</tbody>
</table>

<h2>F: Fluke 8588A Aperture Parameters</h2>
<p>
The aperture is the duration after each trigger where samples at a rate of 5 MHz are averaged together. 
<br>
<br>The aperture can be set from 0 ns to 3 ms in 200 ns increments up to 1 ms, and 100 μs increments from 
1 ms to 3 ms.
<br>
<br>Since the minimum duration to trigger one sample is 200ns, an aperture length greater than 0 ns allows 
more than one sample to be captured and averaged by the digitizer. In a sense, increasing the aperture 
lowers the sampling frequency of the digitizer."
<br>
<br>The entire process for one reading is 200 ns, which gives a maximum trigger rate of 5 MHz. The aperture 
can be set from 0 ns to 3 ms in 200 ns increments up to 1 ms, and 100 μs increments from 1 ms to 3 ms. 
Greater aperture length decreases sample rate.
<br>
<br>
</p>

<table align="left">
	<tr>
		<th>Aperture</th>
		<th>Time</th>
		<th>Samples Averaged (#)</th>
		<th>Fs</th>
	</tr>
	<tr>
		<td>0ns</td>
		<td>200ns</td>
		<td>1</td>
		<td>5 MHz</td>
	</tr>
	<tr>
		<td>200ns</td>
		<td>200ns + 200ns</td>
		<td>2</td>
		<td>2.5 MHz</td>
	</tr>
	<tr>
		<td>400ns</td>
		<td>400ns + 200ns</td>
		<td>3</td>
		<td>1.6667 MHz</td>
	</tr>
	<tr>
		<td>600ns</td> 
		<td>600ns + 200ns</td>
		<td>4</td>
		<td>1.25 MHz</td>
	</tr>
	<tr>
		<td>800ns</td> 
		<td>800ns + 200ns</td>
		<td>5</td>
		<td>833.33 kHz</td>
	</tr>
	<tr>
		<td>1us</td> 
		<td>1us + 0.2us</td>
		<td>6</td>
		<td>833.33 kHz</td>
	</tr>
</table>